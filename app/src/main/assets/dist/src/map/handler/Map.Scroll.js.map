{"version":3,"file":"Map.Scroll.js","sourceRoot":"","sources":["../../../../../../../../../browser/src/map/handler/Map.Scroll.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * L.Handler.Scroll is used by L.Map to enable mouse scroll wheel zoom on the map.\n */\n\n/* global app */\nL.Map.mergeOptions({\n\tscrollHandler: true,\n\twheelDebounceTime: 40,\n\t// Max idle time w.r.t ctrl+wheel events before invoking \"zoomStepEnd\".\n\twheelZoomStepEndAfter: 500,\n\t// Step size in zoom level(log scale) for ctrl + wheel zoom animation.\n\tzoomLevelStepSize: 0.3,\n});\n\nL.Map.Scroll = L.Handler.extend({\n\taddHooks: function () {\n\t\tL.DomEvent.on(this._map._container, {\n\t\t\twheel: this._onWheelScroll,\n\t\t\tmousewheel: this._onWheelScroll,\n\t\t\tMozMousePixelScroll: L.DomEvent.preventDefault\n\t\t}, this);\n\n\t\tthis._delta = 0;\n\t\tthis._vertical = 1;\n\t\tthis.lastY = 0;\n\t\tthis.lastX = 0;\n\n\t\tif (!this._map.touchGesture) {\n\t\t\tL.DomEvent.on(this._map._container, {\n\t\t\t\ttouchstart: this._onTouchScrollStart,\n\t\t\t\ttouchmove: this._onTouchScroll,\n\t\t\t}, this);\n\t\t}\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(this._map._container, {\n\t\t\tmousewheel: this._onWheelScroll,\n\t\t\tMozMousePixelScroll: L.DomEvent.preventDefault\n\t\t}, this);\n\t\tif (!this._map.touchGesture) {\n\t\t\tL.DomEvent.off(this._map._container, {\n\t\t\t\ttouchstart: this._onTouchScrollStart,\n\t\t\t\ttouchmove: this._onTouchScroll,\n\t\t\t}, this);\n\t\t}\n\t},\n\n\t_onTouchScrollStart: function (e) {\n\t\tthis.lastX = e.touches[0].clientX;\n\t\tthis.lastY = e.touches[0].clientY;\n\t},\n\n\t_onTouchScroll: function (e) {\n\t\tvar top = e.touches[0].clientY;\n\t\tvar start = e.touches[0].clientX;\n\t\tvar deltaX = (start - this.lastX);\n\t\tvar deltaY = (top - this.lastY);\n\t\tvar debounce = this._map.options.wheelDebounceTime;\n\t\tif (!this._startTime) {\n\t\t\tthis._startTime = +new Date();\n\t\t}\n\t\tvar left = Math.max(debounce - (+new Date() - this._startTime), 0);\n\t\tclearTimeout(this._timer);\n\n\t\tthis.lastY = top;\n\t\tif (Math.abs(deltaX) > Math.abs(deltaY)) {\n\t\t\tthis._vertical = 0;\n\t\t\tthis._delta += deltaX / 120;\n\t\t} else {\n\t\t\tthis._delta += deltaY / 120;\n\t\t\tthis._vertical = 1;\n\t\t}\n\t\tthis._timer = setTimeout(L.bind(this._performScroll, this), left);\n\t},\n\n\t_onWheelScroll: function (e) {\n\t\tvar delta =  -1 * e.deltaY; // L.DomEvent.getWheelDelta(e);\n\t\tvar debounce = this._map.options.wheelDebounceTime;\n\n\t\tthis._delta = delta;\n\t\tvar viewCenter = this._map.getCenter();\n\t\tvar mousePos = this._map.mouseEventToLatLng(e);\n\n\t\tvar docLayer = this._map._docLayer;\n\t\tif (docLayer.isCalc()) {\n\t\t\tthis._zoomCenter = mousePos;\n\t\t} else if (docLayer.isWriter()) {\n\t\t\t// Preserve the y coordinate position of the document where the mouse is.\n\t\t\t// Also preserve x coordinate if the current view does not have margins.\n\t\t\t//  If view has margins, we cannot center w.r.t arbitary position in the page because\n\t\t\t//  writer will eventually re-adjust page to the view's center after setting map zoom.\n\t\t\tvar part = docLayer._currentPage;\n\t\t\tvar rectangle = app.file.writer.pageRectangleList[part];\n\t\t\tvar minX = Math.round(rectangle[0] * app.twipsToPixels);\n\t\t\tvar maxX = minX + Math.round(rectangle[2] * app.twipsToPixels);\n\t\t\tvar viewBounds = this._map.getPixelBoundsCore();\n\t\t\tvar useMouseXCenter = viewBounds.min.x >= 0 && viewBounds.max.x <= maxX;\n\n\t\t\tthis._zoomCenter = new L.LatLng(mousePos.lat, useMouseXCenter ? mousePos.lng : viewCenter.lng);\n\n\t\t} else {\n\t\t\tthis._zoomCenter = viewCenter;\n\t\t}\n\n\t\tif (!this._startTime) {\n\t\t\tthis._startTime = +new Date();\n\t\t}\n\n\t\tvar left = Math.max(debounce - (+new Date() - this._startTime), 0);\n\n\t\tclearTimeout(this._timer);\n\t\tif (e.ctrlKey) {\n\t\t\tthis._timer = setTimeout(L.bind(this._performZoom, this), left);\n\t\t}\n\n\t\tL.DomEvent.stop(e);\n\t},\n\n\t_performScroll: function () {\n\t\tvar map = this._map,\n\t\t    delta = -this._delta,\n\t\t    scrollAmount = Math.round(map.getSize().y / 20);\n\n\t\tthis._delta = 0;\n\t\tthis._startTime = null;\n\n\t\tif (!delta) { return; }\n\t\tmap.fire('scrollby', {x: (1 - this._vertical) * delta * scrollAmount, y: this._vertical * delta * scrollAmount});\n\t},\n\n\t_performZoom: function () {\n\t\tvar lastScrollTime = this._zoomScrollTime;\n\t\tthis._zoomScrollTime = new Date();\n\t\tvar map = this._map;\n\t\tvar mapZoom = map.getZoom();\n\n\t\tvar newAnimation = !lastScrollTime ||\n\t\t\t(this._zoomScrollTime - lastScrollTime) > this._map.options.wheelZoomStepEndAfter;\n\n\t\tif (newAnimation && this._inZoomAnimation) {\n\t\t\t// Animation is on-going. Send this frame request to the ongoing one?\n\t\t\tthis._zoomScrollTime = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tvar delta = this._delta;\n\t\tmap.stop(); // stop panning and fly animations if any\n\n\t\t// Restrict delta to { -1, 0, 1 }\n\t\tdelta = delta > 0 ? Math.ceil(delta) : Math.floor(delta);\n\t\tdelta = Math.max(Math.min(delta, 1), -1);\n\n\t\tthis._delta = 0;\n\t\tthis._startTime = null;\n\n\t\tif (!delta) { return; }\n\n\t\t// Compute current zoom-frame's level.\n\t\tvar prevZoom = newAnimation ? mapZoom : this._zoom;\n\t\tthis._zoom = map._limitZoom(prevZoom + delta);\n\t\tif (newAnimation && this._zoom === mapZoom) {\n\t\t\t// We hit limits, don't start a new animation.\n\t\t\tthis._zoomScrollTime = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tthis._stopZoomInterpolateRAFAt = this._zoomScrollTime.valueOf() + this._map.options.wheelZoomStepEndAfter;\n\n\t\tif (newAnimation) {\n\t\t\tthis._inZoomAnimation = true;\n\t\t\tthis._map._docLayer.preZoomAnimation();\n\t\t\tthis._zoomInterpolateRAF = requestAnimationFrame(this._zoomInterpolateRAFFunc.bind(this));\n\t\t}\n\t},\n\n\t// RAF function that generates intermediate zoom-levels between scroll events.\n\t_zoomInterpolateRAFFunc: function () {\n\t\tvar lastZoom = this._lastFrameZoom || this._map.getZoom();\n\t\tvar toZoom = this._zoom; // This can vary while RAF is running.\n\t\tvar step = this._map.options.zoomLevelStepSize;\n\t\tvar zoomOut = toZoom < lastZoom;\n\t\tvar frameZoom = zoomOut ? Math.max(toZoom, lastZoom - step) :\n\t\t\tMath.min(toZoom, lastZoom + step);\n\n\t\tif (frameZoom !== toZoom)\n\t\t\tthis._map._docLayer.zoomStep(frameZoom, this._zoomCenter);\n\n\t\tthis._lastFrameZoom = frameZoom;\n\t\tvar now = (new Date()).valueOf();\n\t\tif (now < this._stopZoomInterpolateRAFAt)\n\t\t\tthis._zoomInterpolateRAF = requestAnimationFrame(this._zoomInterpolateRAFFunc.bind(this));\n\t\telse\n\t\t\tthis._stopZoomAnimation();\n\t},\n\n\t_stopZoomAnimation: function () {\n\t\tcancelAnimationFrame(this._zoomInterpolateRAF); // Already cancelled by now ?\n\t\tvar zoom = this._zoom;\n\t\tvar lastCenter = new L.LatLng(this._zoomCenter.lat, this._zoomCenter.lng);\n\t\tvar map = this._map;\n\t\tmap._docLayer.zoomStepEnd(zoom, lastCenter,\n\t\t\t// mapUpdater\n\t\t\tfunction (newMapCenter) {\n\t\t\t\tmap.setView(newMapCenter || lastCenter, zoom);\n\t\t\t},\n\t\t\t// showMarkers\n\t\t\tfunction () {\n\t\t\t\tmap._docLayer.postZoomAnimation();\n\t\t\t\tthis._inZoomAnimation = false;\n\t\t\t}.bind(this),\n\t\t\ttrue /* noGap */);\n\t},\n});\n"]}