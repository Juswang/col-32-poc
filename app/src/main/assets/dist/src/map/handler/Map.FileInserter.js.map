{"version":3,"file":"Map.FileInserter.js","sourceRoot":"","sources":["../../../../../../../../../browser/src/map/handler/Map.FileInserter.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * L.Map.FileInserter is handling the fileInserter action\n */\n\n/* global app _ Uint8Array errorMessages */\n\nL.Map.mergeOptions({\n\tfileInserter: true\n});\n\nL.Map.FileInserter = L.Handler.extend({\n\n\tinitialize: function (map) {\n\t\tthis._map = map;\n\t\tthis._childId = null;\n\t\tthis._toInsert = {};\n\t\tthis._toInsertURL = {};\n\t\tthis._toInsertBackground = {};\n\t\tvar parser = document.createElement('a');\n\t\tparser.href = window.host;\n\t},\n\n\tgetWopiUrl: function (map) {\n\t\treturn window.makeHttpUrlWopiSrc('/' + map.options.urlPrefix + '/', map.options.doc, '/insertfile');\n\t},\n\n\taddHooks: function () {\n\t\tthis._map.on('insertfile', this._onInsertFile, this);\n\t\tthis._map.on('inserturl', this._onInsertURL, this);\n\t\tthis._map.on('childid', this._onChildIdMsg, this);\n\t\tthis._map.on('selectbackground', this._onSelectBackground, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._map.off('insertfile', this._onInsertFile, this);\n\t\tthis._map.off('inserturl', this._onInsertURL, this);\n\t\tthis._map.off('childid', this._onChildIdMsg, this);\n\t\tthis._map.off('selectbackground', this._onSelectBackground, this);\n\t},\n\n\t_onInsertFile: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsert[Date.now()] = e.file;\n\t\t}\n\t\telse {\n\t\t\tthis._sendFile(Date.now(), e.file, 'graphic');\n\t\t}\n\t},\n\n\t_onInsertURL: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertURL[Date.now()] = e.url;\n\t\t}\n\t\telse {\n\t\t\tthis._sendURL(Date.now(), e.url);\n\t\t}\n\t},\n\n\t_onSelectBackground: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertBackground[Date.now()] = e.file;\n\t\t}\n\t\telse {\n\t\t\tthis._sendFile(Date.now(), e.file, 'selectbackground');\n\t\t}\n\t},\n\n\t_onChildIdMsg: function (e) {\n\t\t// When childId is not created (usually when we insert file/URL very first time), we send message to get child ID\n\t\t// and store the file(s) into respective arrays (look at _onInsertFile, _onInsertURL, _onSelectBackground)\n\t\t// When we receive the childId we empty all the array and insert respective file/URL from here\n\n\t\tthis._childId = e.id;\n\t\tfor (var name in this._toInsert) {\n\t\t\tthis._sendFile(name, this._toInsert[name], 'graphic');\n\t\t}\n\t\tthis._toInsert = {};\n\n\t\tfor (name in this._toInsertURL) {\n\t\t\tthis._sendURL(name, this._toInsertURL[name]);\n\t\t}\n\t\tthis._toInsertURL = {};\n\n\t\tfor (name in this._toInsertBackground) {\n\t\t\tthis._sendFile(name, this._toInsertBackground[name], 'selectbackground');\n\t\t}\n\t\tthis._toInsertBackground = {};\n\t},\n\n\t_sendFile: function (name, file, type) {\n\t\tvar socket = app.socket;\n\t\tvar map = this._map;\n\t\tvar url = this.getWopiUrl(map);\n\n\t\tif ('processCoolUrl' in window) {\n\t\t\turl = window.processCoolUrl({ url: url, type: 'insertfile' });\n\t\t}\n\n\t\tif (!(file.filename && file.url) && (file.name === '' || file.size === 0)) {\n\t\t\tvar errMsg =  _('The file of type: %0 cannot be uploaded to server since the file has no name');\n\t\t\tif (file.size === 0)\n\t\t\t\terrMsg = _('The file of type: %0 cannot be uploaded to server since the file is empty');\n\t\t\terrMsg = errMsg.replace('%0', file.type);\n\t\t\tmap.fire('error', {msg: errMsg});\n\t\t\treturn;\n\t\t}\n\n\t\tthis._toInsertBackground = {};\n\n\t\tif (window.ThisIsAMobileApp) {\n\t\t\t// Pass the file contents as a base64-encoded parameter in an insertfile message\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = (function(aFile) {\n\t\t\t\treturn function(e) {\n\t\t\t\t\tvar byteBuffer = new Uint8Array(e.target.result);\n\t\t\t\t\tvar strBytes = '';\n\t\t\t\t\tfor (var i = 0; i < byteBuffer.length; i++) {\n\t\t\t\t\t\tstrBytes += String.fromCharCode(byteBuffer[i]);\n\t\t\t\t\t}\n\t\t\t\t\twindow.postMobileMessage('insertfile name=' + aFile.name + ' type=' + type +\n\t\t\t\t\t\t\t\t\t\t       ' data=' + window.btoa(strBytes));\n\t\t\t\t};\n\t\t\t})(file);\n\t\t\treader.onerror = function(e) {\n\t\t\t\twindow.postMobileError('Error when reading file: ' + e);\n\t\t\t};\n\t\t\treader.onprogress = function(e) {\n\t\t\t\twindow.postMobileDebug('FileReader progress: ' + Math.round(e.loaded*100 / e.total) + '%');\n\t\t\t};\n\t\t\treader.readAsArrayBuffer(file);\n\t\t} else {\n\t\t\tvar xmlHttp = new XMLHttpRequest();\n\t\t\tthis._map.showBusy(_('Uploading...'), false);\n\t\t\txmlHttp.onreadystatechange = function () {\n\t\t\t\tif (xmlHttp.readyState === 4) {\n\t\t\t\t\tmap.hideBusy();\n\t\t\t\t\tif (xmlHttp.status === 200) {\n\t\t\t\t\t\tsocket.sendMessage('insertfile name=' + name + ' type=' + type);\n\t\t\t\t\t}\n\t\t\t\t\telse if (xmlHttp.status === 404) {\n\t\t\t\t\t\tmap.fire('error', {msg: errorMessages.uploadfile.notfound});\n\t\t\t\t\t}\n\t\t\t\t\telse if (xmlHttp.status === 413) {\n\t\t\t\t\t\tmap.fire('error', {msg: errorMessages.uploadfile.toolarge});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar msg = _('Uploading file to server failed with status: %0');\n\t\t\t\t\t\tmsg = msg.replace('%0', xmlHttp.status);\n\t\t\t\t\t\tmap.fire('error', {msg: msg});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\txmlHttp.open('POST', url, true);\n\t\t\tvar formData = new FormData();\n\t\t\tformData.append('name', name);\n\t\t\tformData.append('childid', this._childId);\n\t\t\tif (file.filename && file.url) {\n\t\t\t\tformData.append('url', file.url);\n\t\t\t\tformData.append('filename', file.filename);\n\t\t\t} else {\n\t\t\t\tformData.append('file', file);\n\t\t\t}\n\t\t\txmlHttp.send(formData);\n\n\t\t\t// Set it to null in case server restarts/shuts down or the user reconnects after being idle\n\t\t\t// these change the childId but it would be cached already with the old one if a previous insertfile is made.\n\t\t\t// in that case we would get http error 400 because of the wrong childId.\n\t\t\t// when it's null we ask for a new childId before uploading.\n\t\t\tthis._childId = null;\n\t\t}\n\t},\n\n\t_sendURL: function (name, url) {\n\t\tapp.socket.sendMessage('insertfile name=' + encodeURIComponent(url) + ' type=graphicurl');\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'fileInserter', L.Map.FileInserter);\n"]}