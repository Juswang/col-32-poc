{"version":3,"file":"Map.Welcome.js","sourceRoot":"","sources":["../../../../../../../../../browser/src/map/handler/Map.Welcome.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * L.Map.Welcome.\n */\n\n/* global app _ */\nL.Map.mergeOptions({\n\twelcome: true\n});\n\nL.Map.Welcome = L.Handler.extend({\n\n\tinitialize: function (map) {\n\t\tL.Handler.prototype.initialize.call(this, map);\n\t\tthis._map.on('statusindicator', this.onStatusIndicator, this);\n\n\t\tthis._url = window.welcomeUrl ? window.welcomeUrl: L.LOUtil.getURL('/welcome/welcome.html');\n\t\tthis._retries = 2;\n\t\tthis._fallback = false;\n\t},\n\n\taddHooks: function () {\n\t\tL.DomEvent.on(window, 'message', this.onMessage, this);\n\t\tthis.remove();\n\t},\n\n\tonStatusIndicator: function (e) {\n\t\tif (e.statusType === 'alltilesloaded' && this.shouldWelcome()) {\n\t\t\tthis._map.off('statusindicator', this.onStatusIndicator, this);\n\t\t\tthis.showWelcomeDialog();\n\t\t}\n\t},\n\n\tshouldWelcome: function() {\n\t\tvar storedVersion = localStorage.getItem('WSDWelcomeVersion');\n\t\tvar currentVersion = app.socket.WSDServer.Version;\n\t\tvar welcomeDisabledCookie = localStorage.getItem('WSDWelcomeDisabled');\n\t\tvar welcomeDisabledDate = localStorage.getItem('WSDWelcomeDisabledDate');\n\t\tvar isWelcomeDisabled = false;\n\n\t\tif (welcomeDisabledCookie && welcomeDisabledDate) {\n\t\t\t// Check if we are stil in the same day\n\t\t\tvar currentDate = new Date();\n\t\t\tif (welcomeDisabledDate === currentDate.toDateString())\n\t\t\t\tisWelcomeDisabled = true;\n\t\t\telse {\n\t\t\t\t//Values expired. Clear the local values\n\t\t\t\tlocalStorage.removeItem('WSDWelcomeDisabled');\n\t\t\t\tlocalStorage.removeItem('WSDWelcomeDisabledDate');\n\t\t\t}\n\t\t}\n\n\t\tif ((!storedVersion || storedVersion !== currentVersion) && !isWelcomeDisabled) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tshowWelcomeDialog: function() {\n\t\tif (this._iframeWelcome && this._iframeWelcome.queryContainer())\n\t\t\tthis.remove();\n\n\t\tthis._iframeWelcome = L.iframeDialog(this._url, null, null, { prefix: 'iframe-welcome' });\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(window, 'message', this.onMessage, this);\n\t\tthis.remove();\n\t},\n\n\tremove: function () {\n\t\tif (this._iframeWelcome) {\n\t\t\tthis._iframeWelcome.remove();\n\t\t\tdelete this._iframeWelcome;\n\t\t}\n\t},\n\n\tonMessage: function (e) {\n\t\tvar data = JSON.parse(e.data);\n\n\t\tif (data.MessageId === 'welcome-show') {\n\t\t\tthis._iframeWelcome.show();\n\t\t} else if (data.MessageId == 'welcome-translate') {\n\t\t\tthis._iframeWelcome.clearTimeout();\n\t\t\tvar keys = Object.keys(data.strings);\n\t\t\tfor (var it in keys) {\n\t\t\t\tdata.strings[keys[it]] = _(keys[it]).replace('%coolVersion', window.coolwsdVersion);\n\t\t\t}\n\t\t\tthis._iframeWelcome.postMessage(data);\n\t\t} else if (data.MessageId === 'welcome-close') {\n\t\t\tlocalStorage.setItem('WSDWelcomeVersion', app.socket.WSDServer.Version);\n\t\t\tthis.remove();\n\t\t} else if (data.MessageId == 'iframe-welcome-load' && !this._iframeWelcome.isVisible()) {\n\t\t\tif (this._retries-- > 0) {\n\t\t\t\tthis.remove();\n\t\t\t\tsetTimeout(L.bind(this.showWelcomeDialog, this), 200);\n\t\t\t} else if (this._fallback) {\n\t\t\t\tvar currentDate = new Date();\n\t\t\t\tlocalStorage.setItem('WSDWelcomeDisabled', 'true');\n\t\t\t\tlocalStorage.setItem('WSDWelcomeDisabledDate', currentDate.toDateString());\n\t\t\t\tthis.remove();\n\t\t\t} else {\n\t\t\t\t// fallback\n\t\t\t\tvar welcomeLocation = L.LOUtil.getURL('/welcome/welcome.html');\n\t\t\t\tif (window.socketProxy)\n\t\t\t\t\twelcomeLocation = window.makeWsUrl(welcomeLocation);\n\n\t\t\t\tthis._url = welcomeLocation;\n\t\t\t\tthis._fallback = true;\n\t\t\t\tsetTimeout(L.bind(this.showWelcomeDialog, this), 200);\n\t\t\t}\n\t\t}\n\t}\n});\n\nif ((window.enableWelcomeMessage || window.welcomeUrl) && window.isLocalStorageAllowed) {\n\tL.Map.addInitHook('addHandler', 'welcome', L.Map.Welcome);\n}\n\n"]}