{"version":3,"file":"Map.Infobar.js","sourceRoot":"","sources":["../../../../../../../../../browser/src/map/handler/Map.Infobar.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * L.Map.Infobar.\n */\n/* global app */\n\nL.Map.Infobar = L.Handler.extend({\n\n\tinitialize: function (map) {\n\t\tL.Handler.prototype.initialize.call(this, map);\n\t\tmap.on('updateviewslist', this.onUpdateList, this);\n\t},\n\n\tonUpdateList: function () {\n\t\tvar docLayer = this._map._docLayer || {};\n\t\tvar viewInfo = this._map._viewInfo[docLayer._viewId];\n\n\t\tif (viewInfo && !this.enabled() && viewInfo.userextrainfo &&\n\t\t    viewInfo.userextrainfo.is_admin) {\n\t\t\tvar laterDate = new Date();\n\t\t\tvar currentDate = new Date();\n\t\t\tvar timeValue = window.localStorage.getItem('InfoBarLaterDate');\n\t\t\tif (!timeValue || isNaN(timeValue)) {\n\t\t\t\t/* - 5 seconds */\n\t\t\t\tlaterDate.setTime(currentDate.getTime() - 5000);\n\t\t\t} else {\n\t\t\t\t/* + 5 days (432,000,000 Milliseconds) */\n\t\t\t\ttimeValue = Number(timeValue);\n\t\t\t\tlaterDate.setTime(timeValue + 432000000);\n\t\t\t}\n\n\t\t\tif (currentDate > laterDate)\n\t\t\t\tthis.enable();\n\t\t}\n\t},\n\n\taddHooks: function () {\n\t\tthis._map.off('updateviewslist', this.onUpdateList, this);\n\t\tL.DomEvent.on(window, 'message', this.onMessage, this);\n\n\t\tthis.remove();\n\n\t\tvar loolwsdHash = document.querySelector('#loolwsd-version a') || {};\n\t\tvar lokitHash = document.querySelector('#lokit-version a') || {};\n\n\t\tloolwsdHash = loolwsdHash ? loolwsdHash.innerText : '';\n\t\tlokitHash = lokitHash ? lokitHash.innerText : '';\n\n\t\tvar params = [{ 'loolwsd_git_hash': loolwsdHash },\n\t\t\t      { 'lokit_git_hash': lokitHash }];\n\n\t\tvar options = {\n\t\t\tprefix: 'div-infobar',\n\t\t\tmethod: 'post'\n\t\t};\n\n\t\tthis._iframeInfobar = L.iframeDialog(window.infobarUrl, params,\n\t\t\t\t\t\t     L.DomUtil.get('main-document-content'),\n\t\t\t\t\t\t     options);\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(window, 'message', this.onMessage, this);\n\t\tthis.remove();\n\t},\n\n\tremove: function () {\n\t\tif (this._iframeInfobar && this._iframeInfobar.hasLoaded()) {\n\t\t\tthis._iframeInfobar.remove();\n\t\t\tdelete this._iframeInfobar;\n\t\t}\n\t},\n\n\tonMessage: function (e) {\n\t\tvar data = e.data;\n\n\t\tif (data.startsWith('updatecheck-show-')) {\n\t\t\tvar latestVersion = data.replace('updatecheck-show-', '').split('.');\n\t\t\tvar currentVersion = app.socket.WSDServer.Version.split('.');\n\t\t\tvar length = Math.max(latestVersion.length, currentVersion.length);\n\t\t\tfor (var i = 0; i < length; i++) {\n\t\t\t\tvar v1 = i < latestVersion.length ? parseInt(latestVersion[i]) : 0;\n\t\t\t\tvar v2 = i < currentVersion.length ? parseInt(currentVersion[i]) : 0;\n\n\t\t\t\tif (v1 > v2) {\n\t\t\t\t\tvar currentDate = new Date();\n\t\t\t\t\twindow.localStorage.setItem('InfoBarLaterDate', currentDate.getTime());\n\t\t\t\t\tthis._iframeInfobar.show();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (v1 < v2) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (data === 'updatecheck-close') {\n\t\t\tthis._map.infobar.disable();\n\t\t}\n\t}\n});\n\nif (window.infobarUrl && window.isLocalStorageAllowed) {\n\tL.Map.addInitHook('addHandler', 'infobar', L.Map.Infobar);\n}\n"]}