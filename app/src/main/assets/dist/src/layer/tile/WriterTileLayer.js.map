{"version":3,"file":"WriterTileLayer.js","sourceRoot":"","sources":["../../../../../../../../../browser/src/layer/tile/WriterTileLayer.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Writer tile layer is used to display a text document\n */\n\n/* global app */\nL.WriterTileLayer = L.CanvasTileLayer.extend({\n\n\tnewAnnotation: function (comment) {\n\t\tif (this._map._isCursorVisible) {\n\t\t\tvar temp = this._latLngToTwips(this._visibleCursor.getNorthEast());\n\t\t\tcomment.anchorPos = [temp.x, temp.y];\n\t\t} else if (this._graphicSelection && !this._isEmptyRectangle(this._graphicSelection)) {\n\t\t\t// An image is selected, then guess the anchor based on the graphic selection.\n\t\t\ttemp = this._latLngToTwips(this._graphicSelection.getSouthWest());\n\t\t\tcomment.anchorPos = [temp.x, temp.y];\n\t\t}\n\n\t\tvar commentListSection = app.sectionContainer.getSectionWithName(L.CSections.CommentList.name);\n\t\tif (commentListSection) {\n\t\t\tvar annotation = commentListSection.add(comment);\n\t\t\tcommentListSection.modify(annotation);\n\t\t}\n\t},\n\n\tbeforeAdd: function (map) {\n\t\tmap.uiManager.initializeSpecializedUI('text');\n\t},\n\n\t_onCommandValuesMsg: function (textMsg) {\n\t\tvar braceIndex = textMsg.indexOf('{');\n\t\tif (braceIndex < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar values = JSON.parse(textMsg.substring(braceIndex));\n\t\tif (!values) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar commentListSection = app.sectionContainer.getSectionWithName(L.CSections.CommentList.name);\n\n\t\tif (values.comments) {\n\t\t\tvalues.comments.forEach(function(comment) {\n\t\t\t\tcomment.id = comment.id.toString();\n\t\t\t\tcomment.parent = comment.parent.toString();\n\t\t\t});\n\t\t\tif (commentListSection)\n\t\t\t\tcommentListSection.importComments(values.comments);\n\t\t}\n\t\telse if (values.redlines && values.redlines.length > 0) {\n\t\t\tif (commentListSection)\n\t\t\t\tcommentListSection.importChanges(values.redlines);\n\t\t}\n\t\telse {\n\t\t\tL.CanvasTileLayer.prototype._onCommandValuesMsg.call(this, textMsg);\n\t\t}\n\t},\n\n\t_onInvalidateTilesMsg: function (textMsg) {\n\t\tvar command = app.socket.parseServerCmd(textMsg);\n\t\tif (command.x === undefined || command.y === undefined || command.part === undefined) {\n\t\t\tvar strTwips = textMsg.match(/\\d+/g);\n\t\t\tcommand.x = parseInt(strTwips[0]);\n\t\t\tcommand.y = parseInt(strTwips[1]);\n\t\t\tcommand.width = parseInt(strTwips[2]);\n\t\t\tcommand.height = parseInt(strTwips[3]);\n\t\t\tcommand.part = this._selectedPart;\n\t\t}\n\t\tcommand.part = 0;\n\t\tvar topLeftTwips = new L.Point(command.x, command.y);\n\t\tvar offset = new L.Point(command.width, command.height);\n\t\tvar bottomRightTwips = topLeftTwips.add(offset);\n\t\tif (this._debug) {\n\t\t\tthis._debugAddInvalidationRectangle(topLeftTwips, bottomRightTwips, textMsg);\n\t\t}\n\t\tvar invalidBounds = new L.Bounds(topLeftTwips, bottomRightTwips);\n\t\tvar visibleTopLeft = this._latLngToTwips(this._map.getBounds().getNorthWest());\n\t\tvar visibleBottomRight = this._latLngToTwips(this._map.getBounds().getSouthEast());\n\t\tvar visibleArea = new L.Bounds(visibleTopLeft, visibleBottomRight);\n\t\tvar needsNewTiles = false;\n\t\tfor (var key in this._tiles) {\n\t\t\tvar coords = this._tiles[key].coords;\n\t\t\tvar bounds = this._coordsToTileBounds(coords);\n\t\t\tif (coords.part === command.part && invalidBounds.intersects(bounds)) {\n\t\t\t\tif (this._tiles[key]._invalidCount) {\n\t\t\t\t\tthis._tiles[key]._invalidCount += 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis._tiles[key]._invalidCount = 1;\n\t\t\t\t}\n\t\t\t\tif (visibleArea.intersects(bounds)) {\n\t\t\t\t\tneedsNewTiles = true;\n\t\t\t\t\tif (this._debug) {\n\t\t\t\t\t\tthis._debugAddInvalidationData(this._tiles[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// tile outside of the visible area, just remove it\n\t\t\t\t\tthis._removeTile(key);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (needsNewTiles && this._debug)\n\t\t{\n\t\t\tthis._debugAddInvalidationMessage(textMsg);\n\t\t}\n\n\t\tfor (key in this._tileCache) {\n\t\t\t// compute the rectangle that each tile covers in the document based\n\t\t\t// on the zoom level\n\t\t\tcoords = this._keyToTileCoords(key);\n\t\t\tbounds = this._coordsToTileBounds(coords);\n\t\t\tif (invalidBounds.intersects(bounds)) {\n\t\t\t\tdelete this._tileCache[key];\n\t\t\t}\n\t\t}\n\n\t\tthis._previewInvalidations.push(invalidBounds);\n\t\t// 1s after the last invalidation, update the preview\n\t\tclearTimeout(this._previewInvalidator);\n\t\tthis._previewInvalidator = setTimeout(L.bind(this._invalidatePreviews, this), this.options.previewInvalidationTimeout);\n\t},\n\n\t_onSetPartMsg: function (textMsg) {\n\t\tvar part = parseInt(textMsg.match(/\\d+/g)[0]);\n\t\tif (part !== this._selectedPart) {\n\t\t\tthis._currentPage = part;\n\t\t\tthis._map.fire('pagenumberchanged', {\n\t\t\t\tcurrentPage: part,\n\t\t\t\tpages: this._pages,\n\t\t\t\tdocType: this._docType\n\t\t\t});\n\t\t}\n\t},\n\n\t_onStatusMsg: function (textMsg) {\n\t\tvar command = app.socket.parseServerCmd(textMsg);\n\t\tif (!command.width || !command.height || this._documentInfo === textMsg)\n\t\t\treturn;\n\n\t\tvar sizeChanged = command.width !== this._docWidthTwips || command.height !== this._docHeightTwips;\n\t\tif (sizeChanged) {\n\t\t\tthis._docWidthTwips = command.width;\n\t\t\tthis._docHeightTwips = command.height;\n\t\t\tapp.file.size.twips = [this._docWidthTwips, this._docHeightTwips];\n\t\t\tapp.file.size.pixels = [Math.round(this._tileSize * (this._docWidthTwips / this._tileWidthTwips)), Math.round(this._tileSize * (this._docHeightTwips / this._tileHeightTwips))];\n\t\t\tapp.view.size.pixels = app.file.size.pixels.slice();\n\t\t\tthis._docType = command.type;\n\t\t\tthis._viewId = parseInt(command.viewid);\n\t\t\tthis._updateMaxBounds(true);\n\t\t}\n\n\t\tthis._documentInfo = textMsg;\n\t\tthis._selectedPart = 0;\n\t\tthis._parts = 1;\n\t\tthis._currentPage = command.selectedPart;\n\t\tthis._pages = command.parts;\n\t\tapp.file.writer.pageRectangleList = command.pageRectangleList.slice(); // Copy the array.\n\t\tthis._map.fire('pagenumberchanged', {\n\t\t\tcurrentPage: this._currentPage,\n\t\t\tpages: this._pages,\n\t\t\tdocType: this._docType\n\t\t});\n\t\tthis._resetPreFetching(true);\n\t\tthis._update();\n\t},\n});\n"]}