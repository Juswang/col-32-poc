{"version":3,"file":"Permission.js","sourceRoot":"","sources":["../../../../../../../../browser/src/control/Permission.js"],"names":[],"mappings":"AAAA,gCAAgC;AAChC;;GAEG;AACH,wBAAwB;AACxB,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC;IACb,uBAAuB,EAAE;QACxB,KAAK,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE;QAC1C,KAAK,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE;QAC1C,MAAM,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,KAAK,EAAE;KAC5C;IAED,aAAa,EAAE,UAAU,IAAI;QAC5B,IAAI,MAAM,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC;QACtC,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACpB,mEAAmE;QACnE,mDAAmD;QACnD,kHAAkH;QAClH,4EAA4E;QAC5E,4CAA4C;QAC5C,EAAE;QACF,iFAAiF;QACjF,yEAAyE;QACzE,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,EAAE;YACjH,MAAM,CAAC,IAAI,EAAE,CAAC;SACd;aAAM;YACN,MAAM,CAAC,IAAI,EAAE,CAAC;SACd;QACD,IAAI,IAAI,GAAG,IAAI,CAAC;QAChB,IAAI,IAAI,KAAK,MAAM,EAAE;YACpB,IAAI,IAAI,CAAC,oBAAoB,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE;gBACpF,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE;oBAClB,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBAC1B,CAAC,CAAC,CAAC;gBAEH,kEAAkE;gBAClE,IAAI,CAAC,kBAAkB,CAAC,UAAU,CAAC,CAAC;aACpC;iBACI,IAAI,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE;gBACjC,4EAA4E;gBAC5E,IAAI,CAAC,iBAAiB,EAAE,CAAC;aACzB;iBACI;gBACJ,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;aAC1B;SACD;aACI,IAAI,IAAI,KAAK,MAAM,IAAI,IAAI,KAAK,UAAU,EAAE;YAChD,IAAI,IAAI,CAAC,oBAAoB,EAAE,EAAE;gBAChC,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE;oBAClB,IAAI,CAAC,eAAe,EAAE,CAAC;gBACxB,CAAC,CAAC,CAAC;aACH;iBACI,IAAI,MAAM,CAAC,mBAAmB,EAAE;gBACpC,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE;oBAClB,IAAI,CAAC,gBAAgB,EAAE,CAAC;gBACzB,CAAC,CAAC,CAAC;aACH;iBAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,EAAE;gBAC1F,CAAC,CAAC,qBAAqB,CAAC,CAAC,IAAI,EAAE,CAAC;aAChC;YAED,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;SAC9B;IACF,CAAC;IAED,YAAY,EAAE,UAAS,MAAM;QAC5B,IAAI,IAAI,CAAC,OAAO,CAAC,UAAU,KAAK,SAAS,EAAE;YAC1C,kEAAkE;YAClE,gDAAgD;YAChD,IAAI,CAAC,OAAO,CAAC,UAAU,GAAG,IAAI,CAAC;YAE/B,IAAI,QAAQ,GAAG,CAAC,CAAC,oEAAoE,CAAC,CAAC;YACvF,IAAI,MAAM,EAAE;gBACX,QAAQ,IAAI,IAAI,GAAG,CAAC,CAAC,8BAA8B,CAAC,GAAG,KAAK,GAAG,MAAM,GAAG,GAAG,CAAC;aAC5E;YACD,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC,CAAC;YAExC,IAAI,MAAM,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC;YACtC,6BAA6B;YAC7B,MAAM,CAAC,IAAI,EAAE,CAAC;YACd,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;YAEpB,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE;gBAClB,GAAG,CAAC,MAAM,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;YACvC,CAAC,CAAC,CAAC;SACH;aACI,IAAI,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE;YACjC,2EAA2E;YAC3E,QAAQ,GAAG,CAAC,CAAC,mCAAmC,CAAC,CAAC;YAClD,IAAI,MAAM,EAAE;gBACX,QAAQ,IAAI,IAAI,GAAG,CAAC,CAAC,8BAA8B,CAAC,GAAG,KAAK,GAAG,MAAM,GAAG,GAAG,CAAC;aAC5E;YACD,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC,CAAC;SACxC;QACD,gEAAgE;IACjE,CAAC;IAED,iBAAiB,EAAE,UAAU,QAAQ;QACpC,OAAO,QAAQ,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;IAC1D,CAAC;IAED,oBAAoB,EAAE;QACrB,IAAI,IAAI,CAAC,oBAAoB,EAAE;YAC9B,OAAO,IAAI,CAAC;QACb,IAAI,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,YAAY,CAAC;QACzC,yCAAyC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO,KAAK,CAAC;QAC5B,IAAI,SAAS,GAAG,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QACjD,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,SAAS,CAAC;YACjF,OAAO,KAAK,CAAC;QACd,OAAO,IAAI,CAAC;IACb,CAAC;IAED,gBAAgB,EAAE;QACjB,IAAI,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,YAAY,CAAC;QACzC,IAAI,QAAQ,EAAE;YACb,IAAI,SAAS,GAAG,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;YACjD,IAAI,aAAa,GAAG,IAAI,CAAC,uBAAuB,CAAC,SAAS,CAAC,CAAC;YAC5D,IAAI,aAAa,IAAI,CAAC,aAAa,CAAC,OAAO;gBAC1C,OAAO;SACR;QACD,IAAI,CAAC,OAAO,CAAC,UAAU,GAAG,KAAK,CAAC,CAAC,sCAAsC;QACvE,CAAC,CAAC,qBAAqB,CAAC,CAAC,IAAI,EAAE,CAAC;QAChC,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QAC5B,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE;YACrD,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC5B,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;YAC/B,kEAAkE;YAClE,sDAAsD;YACtD,IAAI,CAAC,CAAC,MAAM,CAAC,eAAe,IAAI,MAAM,CAAC,mBAAmB,CAAC;gBAC1D,IAAI,CAAC,KAAK,EAAE,CAAC;SACd;IACF,CAAC;IAED,YAAY,EAAE;QACb,IAAI,IAAI,GAAG,IAAI,CAAC;QAChB,IAAI,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO,KAAK,CAAC;QAC5B,IAAI,SAAS,GAAG,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QACjD,IAAI,aAAa,GAAG,IAAI,CAAC,uBAAuB,CAAC,SAAS,CAAC,CAAC;QAC5D,IAAI,YAAY,GAAG,aAAa,CAAC,SAAS,CAAC;QAC3C,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC;YACjB,OAAO,EAAE,CAAC,CAAC,mBAAmB,CAAC;YAC/B,WAAW,EAAE,CAAC,CAAC,UAAU,CAAC;YAC1B,KAAK,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC,EAAE,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,GAAG,GAAG,GAAG,YAAY;YAC5E,QAAQ,EAAE,UAAU,KAAK;gBACxB,IAAI,CAAC,KAAK;oBAAE,OAAO;gBACnB,IAAI,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,KAAK,YAAY;oBAC/D,KAAK,GAAG,KAAK,GAAG,GAAG,GAAG,YAAY,CAAC;gBACpC,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;YAClC,CAAC;SACD,CAAC,CAAC;IACJ,CAAC;IAED,8BAA8B;IAC9B,iBAAiB,EAAE;QAClB,wDAAwD;QACxD,IAAI,IAAI,CAAC,oBAAoB,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE;YAC5D,IAAI,IAAI,GAAG,IAAI,CAAC;YAChB,IAAI,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,YAAY,CAAC;YACzC,IAAI,SAAS,GAAG,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;YACjD,IAAI,aAAa,GAAG,IAAI,CAAC,uBAAuB,CAAC,SAAS,CAAC,CAAC;YAE5D,IAAI,UAAU,GAAG,EAAE,CAAC;YACpB,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,uBAAuB,EAAE;gBAC1C,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC,oBAAoB,CAAC,EAAE,CAAC,CAAC,CAAC;aACzF;YACD,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,aAAa,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,oBAAoB,CAAC,EAAC,CAAC,CAAC,CAAC;YAEvI,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC;gBACf,OAAO,EAAE,CAAC,CAAC,kGAAkG,CAAC;gBAC9G,oBAAoB,EAAE,KAAK;gBAC3B,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,UAAU,KAAK;oBAC/B,IAAI,KAAK,EAAE;wBACV,wBAAwB;wBACxB,IAAI,CAAC,YAAY,EAAE,CAAC;qBACpB;yBAAM;wBACN,IAAI,CAAC,gBAAgB,EAAE,CAAC;qBACxB;gBACF,CAAC,EAAE,IAAI,CAAC;gBACR,OAAO,EAAE,UAAU;aACnB,CAAC,CAAC;SACH;aAAM;YACN,IAAI,CAAC,gBAAgB,EAAE,CAAC;SACxB;IACF,CAAC;IAED,gBAAgB,EAAE;QACjB,IAAI,MAAM,CAAC,aAAa,KAAK,UAAU,EAAE;YACxC,MAAM,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;SAC5C;aAAM;YACN,IAAI,CAAC,iBAAiB,EAAE,CAAC;SACzB;IACF,CAAC;IAED,cAAc,EAAE,UAAU,IAAI;QAC7B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAExB,GAAG,CAAC,MAAM,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;QAC5C,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE;YACrB,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;SACxB;QAED,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,EAAC,IAAI,EAAG,IAAI,EAAC,CAAC,CAAC;QAE7C,IAAI,IAAI,CAAC,SAAS,CAAC,QAAQ,KAAK,MAAM,EAAE;YACvC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;SACjB;QAED,IAAI,MAAM,CAAC,eAAe,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,IAAI,CAAC,SAAS,CAAC,QAAQ,KAAK,aAAa;YAChG,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;QAE1B,IAAI,MAAM,CAAC,mBAAmB;YAC7B,MAAM,CAAC,iBAAiB,CAAC,aAAa,CAAC,CAAC;IAC1C,CAAC;IAED,kBAAkB,EAAE,UAAU,IAAI;QACjC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAExB,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;QACvB,8DAA8D;QAC9D,IAAI,IAAI,CAAC,SAAS,EAAE;YACnB,IAAI,CAAC,SAAS,CAAC,eAAe,EAAE,CAAC;YACjC,IAAI,CAAC,SAAS,CAAC,gBAAgB,EAAE,CAAC;YAClC,IAAI,CAAC,SAAS,CAAC,sBAAsB,EAAE,CAAC;SACxC;QACD,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,EAAC,IAAI,EAAG,IAAI,EAAC,CAAC,CAAC;QAC7C,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QAE/B,IAAI,MAAM,CAAC,mBAAmB;YAC7B,MAAM,CAAC,iBAAiB,CAAC,cAAc,CAAC,CAAC;IAC3C,CAAC;IAED,eAAe,EAAE;QAChB,IAAI,IAAI,CAAC,gBAAgB,EAAE,EAAE;YAC5B,OAAO;SACP;QACD,GAAG,CAAC,MAAM,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;QAC5C,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;IACzB,CAAC;IAED,gBAAgB,EAAE;QACjB,IAAI,IAAI,CAAC,gBAAgB,EAAE,EAAE;YAC5B,OAAO;SACP;QACD,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;IACxB,CAAC;IAED,2BAA2B,EAAE;QAC5B,wDAAwD;QACxD,sDAAsD;QACtD,+DAA+D;QAC/D,OAAO,MAAM,CAAC,aAAa,KAAK,MAAM,CAAC;IACxC,CAAC;IAED,oBAAoB,EAAE;QACrB,OAAO,IAAI,CAAC,WAAW,KAAK,UAAU,CAAC;IACxC,CAAC;IAED,gBAAgB,EAAE;QACjB,OAAO,IAAI,CAAC,WAAW,KAAK,MAAM,CAAC;IACpC,CAAC;CACD,CAAC,CAAC","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Document permission handler\n */\n/* global app $ _ vex */\nL.Map.include({\n\treadonlyStartingFormats: {\n\t\t'txt': { canEdit: true, odfFormat: 'odt' },\n\t\t'csv': { canEdit: true, odfFormat: 'ods' },\n\t\t'xlsb': { canEdit: false, odfFormat: 'ods' }\n\t},\n\n\tsetPermission: function (perm) {\n\t\tvar button = $('#mobile-edit-button');\n\t\tbutton.off('click');\n\t\t// app.file.fileBasedView is new view that has continuous scrolling\n\t\t// used for PDF and we dont permit editing for PDFs\n\t\t// this._shouldStartReadOnly() is a check for files that should start in readonly mode and even on desktop browser\n\t\t// we warn the user about loosing the rich formatting and offer an option to\n\t\t// save as ODF instead of the current format\n\t\t//\n\t\t// For mobile we need to display the edit button for all the cases except for PDF\n\t\t// we offer save-as to another place where the user can edit the document\n\t\tif (!app.file.fileBasedView && (this._shouldStartReadOnly() || window.mode.isMobile() || window.mode.isTablet())) {\n\t\t\tbutton.show();\n\t\t} else {\n\t\t\tbutton.hide();\n\t\t}\n\t\tvar that = this;\n\t\tif (perm === 'edit') {\n\t\t\tif (this._shouldStartReadOnly() || window.mode.isMobile() || window.mode.isTablet()) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat._switchToEditMode();\n\t\t\t\t});\n\n\t\t\t\t// temporarily, before the user touches the floating action button\n\t\t\t\tthis._enterReadOnlyMode('readonly');\n\t\t\t}\n\t\t\telse if (this.options.canTryLock) {\n\t\t\t\t// This is a success response to an attempt to lock using mobile-edit-button\n\t\t\t\tthis._switchToEditMode();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis._enterEditMode(perm);\n\t\t\t}\n\t\t}\n\t\telse if (perm === 'view' || perm === 'readonly') {\n\t\t\tif (this.isLockedReadOnlyUser()) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat.openUnlockPopup();\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (window.ThisIsTheAndroidApp) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat._requestFileCopy();\n\t\t\t\t});\n\t\t\t} else if (!this.options.canTryLock && (window.mode.isMobile() || window.mode.isTablet())) {\n\t\t\t\t$('#mobile-edit-button').hide();\n\t\t\t}\n\n\t\t\tthis._enterReadOnlyMode(perm);\n\t\t}\n\t},\n\n\tonLockFailed: function(reason) {\n\t\tif (this.options.canTryLock === undefined) {\n\t\t\t// This is the initial notification. This status is not permanent.\n\t\t\t// Allow to try to lock the file for edit again.\n\t\t\tthis.options.canTryLock = true;\n\n\t\t\tvar alertMsg = _('The document could not be locked, and is opened in read-only mode.');\n\t\t\tif (reason) {\n\t\t\t\talertMsg += '\\n' + _('Server returned this reason:') + '\\n\"' + reason + '\"';\n\t\t\t}\n\t\t\tvex.dialog.alert({ message: alertMsg });\n\n\t\t\tvar button = $('#mobile-edit-button');\n\t\t\t// TODO: modify the icon here\n\t\t\tbutton.show();\n\t\t\tbutton.off('click');\n\n\t\t\tbutton.on('click', function () {\n\t\t\t\tapp.socket.sendMessage('attemptlock');\n\t\t\t});\n\t\t}\n\t\telse if (this.options.canTryLock) {\n\t\t\t// This is a failed response to an attempt to lock using mobile-edit-button\n\t\t\talertMsg = _('The document could not be locked.');\n\t\t\tif (reason) {\n\t\t\t\talertMsg += '\\n' + _('Server returned this reason:') + '\\n\"' + reason + '\"';\n\t\t\t}\n\t\t\tvex.dialog.alert({ message: alertMsg });\n\t\t}\n\t\t// do nothing if this.options.canTryLock is defined and is false\n\t},\n\n\t_getFileExtension: function (filename) {\n\t\treturn filename.substring(filename.lastIndexOf('.') + 1);\n\t},\n\n\t_shouldStartReadOnly: function () {\n\t\tif (this.isLockedReadOnlyUser())\n\t\t\treturn true;\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\t// use this feature for only integration.\n\t\tif (!fileName) return false;\n\t\tvar extension = this._getFileExtension(fileName);\n\t\tif (!Object.prototype.hasOwnProperty.call(this.readonlyStartingFormats, extension))\n\t\t\treturn false;\n\t\treturn true;\n\t},\n\n\t_proceedEditMode: function() {\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\tif (fileName) {\n\t\t\tvar extension = this._getFileExtension(fileName);\n\t\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\t\t\tif (extensionInfo && !extensionInfo.canEdit)\n\t\t\t\treturn;\n\t\t}\n\t\tthis.options.canTryLock = false; // don't respond to lockfailed anymore\n\t\t$('#mobile-edit-button').hide();\n\t\tthis._enterEditMode('edit');\n\t\tif (window.mode.isMobile() || window.mode.isTablet()) {\n\t\t\tthis.fire('editorgotfocus');\n\t\t\tthis.fire('closemobilewizard');\n\t\t\t// In the iOS/android app, just clicking the mobile-edit-button is\n\t\t\t// not reason enough to pop up the on-screen keyboard.\n\t\t\tif (!(window.ThisIsTheiOSApp || window.ThisIsTheAndroidApp))\n\t\t\t\tthis.focus();\n\t\t}\n\t},\n\n\t_offerSaveAs: function() {\n\t\tvar that = this;\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\tif (!fileName) return false;\n\t\tvar extension = this._getFileExtension(fileName);\n\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\t\tvar saveAsFormat = extensionInfo.odfFormat;\n\t\tvex.dialog.prompt({\n\t\t\tmessage: _('Enter a file name'),\n\t\t\tplaceholder: _('filename'),\n\t\t\tvalue: fileName.substring(0, fileName.lastIndexOf('.')) + '.' + saveAsFormat,\n\t\t\tcallback: function (value) {\n\t\t\t\tif (!value) return;\n\t\t\t\tif (value.substring(value.lastIndexOf('.') + 1) !== saveAsFormat)\n\t\t\t\t\tvalue = value + '.' + saveAsFormat;\n\t\t\t\tthat.saveAs(value, saveAsFormat);\n\t\t\t}\n\t\t});\n\t},\n\n\t// from read-only to edit mode\n\t_switchToEditMode: function () {\n\t\t// This will be handled by the native mobile app instead\n\t\tif (this._shouldStartReadOnly() && !window.ThisIsAMobileApp) {\n\t\t\tvar that = this;\n\t\t\tvar fileName = this['wopi'].BaseFileName;\n\t\t\tvar extension = this._getFileExtension(fileName);\n\t\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\n\t\t\tvar buttonList = [];\n\t\t\tif (!this['wopi'].UserCanNotWriteRelative) {\n\t\t\t\tbuttonList.push($.extend({}, vex.dialog.buttons.YES, { text: _('Save as ODF format') }));\n\t\t\t}\n\t\t\tbuttonList.push($.extend({}, vex.dialog.buttons.NO, { text: extensionInfo.canEdit ? _('Continue editing') : _('Continue read only')}));\n\n\t\t\tvex.dialog.open({\n\t\t\t\tmessage: _('This document may contain formatting or content that cannot be saved in the current file format.'),\n\t\t\t\toverlayClosesOnClick: false,\n\t\t\t\tcallback: L.bind(function (value) {\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\t// offer save-as instead\n\t\t\t\t\t\tthis._offerSaveAs();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._proceedEditMode();\n\t\t\t\t\t}\n\t\t\t\t}, that),\n\t\t\t\tbuttons: buttonList\n\t\t\t});\n\t\t} else {\n\t\t\tthis._proceedEditMode();\n\t\t}\n\t},\n\n\t_requestFileCopy: function() {\n\t\tif (window.docPermission === 'readonly') {\n\t\t\twindow.postMobileMessage('REQUESTFILECOPY');\n\t\t} else {\n\t\t\tthis._switchToEditMode();\n\t\t}\n\t},\n\n\t_enterEditMode: function (perm) {\n\t\tthis._permission = perm;\n\n\t\tapp.socket.sendMessage('requestloksession');\n\t\tif (!L.Browser.touch) {\n\t\t\tthis.dragging.disable();\n\t\t}\n\n\t\tthis.fire('updatepermission', {perm : perm});\n\n\t\tif (this._docLayer._docType === 'text') {\n\t\t\tthis.setZoom(10);\n\t\t}\n\n\t\tif (window.ThisIsTheiOSApp && window.mode.isTablet() && this._docLayer._docType === 'spreadsheet')\n\t\t\tthis.showCalcInputBar(0);\n\n\t\tif (window.ThisIsTheAndroidApp)\n\t\t\twindow.postMobileMessage('EDITMODE on');\n\t},\n\n\t_enterReadOnlyMode: function (perm) {\n\t\tthis._permission = perm;\n\n\t\tthis.dragging.enable();\n\t\t// disable all user interaction, will need to add keyboard too\n\t\tif (this._docLayer) {\n\t\t\tthis._docLayer._onUpdateCursor();\n\t\t\tthis._docLayer._clearSelections();\n\t\t\tthis._docLayer._onUpdateTextSelection();\n\t\t}\n\t\tthis.fire('updatepermission', {perm : perm});\n\t\tthis.fire('closemobilewizard');\n\n\t\tif (window.ThisIsTheAndroidApp)\n\t\t\twindow.postMobileMessage('EDITMODE off');\n\t},\n\n\tenableSelection: function () {\n\t\tif (this.isPermissionEdit()) {\n\t\t\treturn;\n\t\t}\n\t\tapp.socket.sendMessage('requestloksession');\n\t\tthis.dragging.disable();\n\t},\n\n\tdisableSelection: function () {\n\t\tif (this.isPermissionEdit()) {\n\t\t\treturn;\n\t\t}\n\t\tthis.dragging.enable();\n\t},\n\n\tisPermissionEditForComments: function() {\n\t\t// Currently we allow user to perform comment operations\n\t\t// even in the view/readonly mode(initial mobile mode)\n\t\t// allow comment operations if user has edit permission for doc\n\t\treturn window.docPermission === 'edit';\n\t},\n\n\tisPermissionReadOnly: function() {\n\t\treturn this._permission === 'readonly';\n\t},\n\n\tisPermissionEdit: function() {\n\t\treturn this._permission === 'edit';\n\t}\n});\n"]}